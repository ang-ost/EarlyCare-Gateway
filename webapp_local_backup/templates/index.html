{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h2><i class="fas fa-hospital-user"></i> Gestione Cartelle Cliniche</h2>
        <p class="subtitle">Sistema integrato per la gestione dei dati clinici</p>
    </div>

    <div class="grid-container">
        <!-- Left Panel - Input -->
        <div class="panel">
            <div class="panel-header">
                <h3><i class="fas fa-folder-open"></i> Cartella Clinica</h3>
            </div>
            <div class="panel-body">
                <!-- Patient Info Display -->
                <div class="section">
                    <h4><i class="fas fa-user"></i> Informazioni Paziente</h4>
                    <div id="patient-info" class="info-box">
                        <p class="text-muted">Nessun paziente selezionato</p>
                    </div>
                </div>

                <!-- File Upload -->
                <div class="section">
                    <h4><i class="fas fa-upload"></i> Carica File Clinici</h4>
                    <div class="upload-area" id="upload-area">
                        <i class="fas fa-cloud-upload-alt fa-3x"></i>
                        <p>Trascina file qui o clicca per selezionare</p>
                        <input type="file" id="file-input" multiple style="display: none;" 
                               onchange="handleFileSelect(event)">
                        <button onclick="document.getElementById('file-input').click()" class="btn btn-secondary">
                            <i class="fas fa-file"></i> Seleziona File
                        </button>
                    </div>
                    <div id="files-list" class="files-list"></div>
                </div>
            </div>
        </div>

        <!-- Right Panel - Results -->
        <div class="panel">
            <div class="panel-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3><i class="fas fa-clipboard-list"></i> Schede Cliniche</h3>
                    <span id="records-count" class="badge">0</span>
                </div>
            </div>
            <div class="panel-body">
                <div id="clinical-records" class="records-container">
                    <p class="text-muted">Nessuna scheda clinica disponibile</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Patient Search Modal -->
<div id="patient-search-modal" class="modal" style="display: none;">
    <div class="modal-content modal-md">
        <div class="modal-header">
            <h3><i class="fas fa-search"></i> Ricerca Paziente</h3>
            <button onclick="closeModal('patient-search-modal')" class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Codice Fiscale</label>
                <input type="text" id="modal-search-cf" class="form-control" 
                       placeholder="Inserisci codice fiscale">
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeModal('patient-search-modal')" class="btn btn-secondary">Annulla</button>
            <button onclick="performSearch()" class="btn btn-primary">
                <i class="fas fa-search"></i> Cerca
            </button>
        </div>
    </div>
</div>

<!-- Patient Form Modal -->
<div id="patient-form-modal" class="modal" style="display: none;">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3><i class="fas fa-user-plus"></i> Nuovo Paziente</h3>
            <button onclick="closeModal('patient-form-modal')" class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <form id="patient-form">
                <h4 style="color: var(--primary); margin-bottom: 1rem;">Dati Anagrafici</h4>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Nome *</label>
                        <input type="text" name="nome" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Cognome *</label>
                        <input type="text" name="cognome" class="form-control" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Data di Nascita *</label>
                        <input type="date" name="data_nascita" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Data di Decesso</label>
                        <input type="date" name="data_decesso" class="form-control">
                        <small style="color: var(--gray);">Lasciare vuoto se in vita</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Comune di Nascita *</label>
                        <input type="text" name="comune_nascita" id="comune_nascita" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Sesso *</label>
                        <div style="display: flex; gap: 1.5rem; align-items: center; padding-top: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0;">
                                <input type="radio" name="sesso" id="sesso_m" value="M" required>
                                <span>Maschio</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0;">
                                <input type="radio" name="sesso" id="sesso_f" value="F" required>
                                <span>Femmina</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Codice Fiscale *</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" name="codice_fiscale" id="codice_fiscale" class="form-control" 
                               pattern="[A-Z]{6}[0-9]{2}[A-Z][0-9]{2}[A-Z][0-9]{3}[A-Z]" 
                               style="text-transform: uppercase; flex: 1;" 
                               maxlength="16" required>
                        <button type="button" id="btn-calculate-cf" onclick="calculateFiscalCode()" class="btn btn-calculate">
                            <i class="fas fa-calculator"></i> Calcola
                        </button>
                    </div>
                    <small style="color: var(--gray);">Compila i campi sopra e clicca "Calcola" per generare automaticamente</small>
                </div>
                
                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--light);">
                <h4 style="color: var(--primary); margin-bottom: 1rem;">Informazioni Cliniche</h4>
                
                <div class="form-group">
                    <label>Allergie</label>
                    <textarea name="allergie" class="form-control" rows="3" 
                              placeholder="Elencare eventuali allergie (es. penicillina, lattice, pollini...)"></textarea>
                    <small style="color: var(--gray);">Separare le allergie con virgola o punto e virgola</small>
                </div>
                
                <div class="form-group">
                    <label>Malattie Permanenti</label>
                    <textarea name="malattie_permanenti" class="form-control" rows="4" 
                              placeholder="Elencare malattie croniche o permanenti (es. diabete, celiachia, malattie cardiovascolari, malattie neurodegenerative...)"></textarea>
                    <small style="color: var(--gray);">Separare le malattie con virgola o punto e virgola</small>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button onclick="closeModal('patient-form-modal')" class="btn btn-secondary">Annulla</button>
            <button onclick="savePatient()" class="btn btn-success">
                <i class="fas fa-save"></i> Salva
            </button>
        </div>
    </div>
</div>

<!-- Add Clinical Record Modal -->
<div id="add-record-modal" class="modal" style="display: none;">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3><i class="fas fa-file-medical"></i> Aggiungi Scheda Clinica</h3>
            <button onclick="closeModal('add-record-modal')" class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <form id="clinical-record-form">
                <div class="form-group">
                    <label>Tipo di Scheda Clinica *</label>
                    <select name="tipo_scheda" class="form-control" required>
                        <option value="">Seleziona...</option>
                        <option value="Visita">Visita</option>
                        <option value="Ricovero">Ricovero</option>
                    </select>
                    <small style="color: var(--gray);">Seleziona se si tratta di una visita ambulatoriale o di un ricovero ospedaliero</small>
                </div>
                <div class="form-group">
                    <label>Motivo Principale *</label>
                    <input type="text" name="chief_complaint" class="form-control" 
                           placeholder="Es. Dolore toracico, Controllo post-operatorio..." required>
                </div>
                <div class="form-group">
                    <label>Sintomi Attuali *</label>
                    <textarea name="symptoms" class="form-control" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label>Diagnosi</label>
                    <textarea name="diagnosis" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Trattamento</label>
                    <textarea name="treatment" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Note Aggiuntive</label>
                    <textarea name="notes" class="form-control" rows="4"></textarea>
                </div>
                <h4>Parametri Vitali</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Pressione Arteriosa</label>
                        <input type="text" name="blood_pressure" class="form-control" placeholder="es. 120/80">
                    </div>
                    <div class="form-group">
                        <label>Frequenza Cardiaca</label>
                        <input type="number" name="heart_rate" class="form-control" placeholder="bpm">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Temperatura</label>
                        <input type="number" step="0.1" name="temperature" class="form-control" placeholder="Â°C">
                    </div>
                    <div class="form-group">
                        <label>Saturazione O2</label>
                        <input type="number" name="oxygen_saturation" class="form-control" placeholder="%">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button onclick="closeModal('add-record-modal')" class="btn btn-secondary">Annulla</button>
            <button onclick="saveClinicalRecord()" class="btn btn-success">
                <i class="fas fa-save"></i> Salva
            </button>
        </div>
    </div>
</div>

<!-- Metrics Modal -->
<div id="metrics-modal" class="modal" style="display: none;">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3><i class="fas fa-chart-line"></i> Metriche Sistema</h3>
            <button onclick="closeModal('metrics-modal')" class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <div id="metrics-content">
                <p class="text-muted">Caricamento metriche...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeModal('metrics-modal')" class="btn btn-secondary">Chiudi</button>
        </div>
    </div>
</div>
{% endblock %}
